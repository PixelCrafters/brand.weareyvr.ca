<!doctype html>
<html>
<head>
  <title>Tangents</title>
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <!-- <script src="https://raw.github.com/jonobr1/two.js/master/build/two.js" charset="utf-8"></script> -->
  <style>
  * { box-sizing: border-box; }
  body { background: #444; font-family: Helvetica; }
  svg, canvas {
    background: #3f3f3f;
    float: left;
    margin: 50px 100px 50px 50px;
  }
  .controls {
    float: left;
  }
  h3, .outlines { margin-top: 40px; }
  </style>
</head>
<body>
  <div class="graphic"></div>
  <div class="controls">
    <h3>One</h3> <!-- Top left -->
    <label>X <input type="range" min="0" max="475" step="1" value="49" name="one.x"></label>
    <label>Y <input type="range" min="0" max="500" step="1" value="49" name="one.y"></label>
    <label>R <input type="range" min="0" max="100" step="1" value="46" name="one.radius"></label>
    <h3>Two</h3> <!-- Top right -->
    <label>X <input type="range" min="0" max="475" step="1" value="426" name="two.x"></label>
    <label>Y <input type="range" min="0" max="500" step="1" value="49" name="two.y"></label>
    <label>R <input type="range" min="0" max="100" step="1" value="46" name="two.radius"></label>
    <h3>Three</h3> <!-- Bottom right -->
    <label>X <input type="range" min="0" max="475" step="1" value="426" name="three.x"></label>
    <label>Y <input type="range" min="0" max="500" step="1" value="451" name="three.y"></label>
    <label>R <input type="range" min="0" max="100" step="1" value="46" name="three.radius"></label>
    <h3>Four</h3> <!-- Bottom left -->
    <label>X <input type="range" min="0" max="475" step="1" value="49" name="four.x"></label>
    <label>Y <input type="range" min="0" max="500" step="1" value="451" name="four.y"></label>
    <label>R <input type="range" min="0" max="100" step="1" value="46" name="four.radius"></label>
    <div class="outlines">
      <label><input type="checkbox"> Outlines</label>
    </div>
  </div>
  <script>
  // For some d3 help: http://jsfiddle.net/D5k8x/

  // Defaults

  var outlines = false;

  // Top left
  var one = {
    radius: 46,
    x: 46 + 3,
    y: 46 + 3,
  };

  // Top right
  var two = {
    radius: 46,
    x: 475 - (46 + 3),
    y: 46 + 3,
  }

  // Bottom right
  var three = {
    radius: 46,
    // x: 475 - (46 + 3),
    x: (475 / 2) + 10,
    y: 500 - (46 + 3),
  };

  // Bottom left
  var four = {
    radius: 46,
    // x: 46 + 3,
    x: (475 / 2) - 10,
    y: 500 - (46 + 3),
  }

  var vis = d3.select(".graphic").append("svg");
  vis.attr('width', 475).attr('height', 500);

  var circleTangents = function(x1, y1, r1, x2, y2, r2) {
    var d_sq = (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2);

    // if (d_sq <= (r1-r2)*(r1-r2)) {
      // return new double[0][4];
    // }

    var d = Math.sqrt(d_sq);
    var vx = (x2 - x1) / d;
    var vy = (y2 - y1) / d;

    var res = [ [], [], [], [] ];

    var i = 0;

    // Let A, B be the centers, and C, D be points at which the tangent
    // touches first and second circle, and n be the normal vector to it.
    //
    // We have the system:
    //   n * n = 1          (n is a unit vector)          
    //   C = A + r1 * n
    //   D = B +/- r2 * n
    //   n * CD = 0         (common orthogonality)
    //
    // n * CD = n * (AB +/- r2*n - r1*n) = AB*n - (r1 -/+ r2) = 0,  <=>
    // AB * n = (r1 -/+ r2), <=>
    // v * n = (r1 -/+ r2) / d,  where v = AB/|AB| = AB/d
    // This is a linear equation in unknown vector n.

    for (var sign1 = 1; sign1 >= -1; sign1 -= 2) {
      var c = (r1 - sign1 * r2) / d;

      // Now we're just intersecting a line with a circle: v*n=c, n*n=1

      if (c*c > 1.0) {
        continue;
      }
      var h = Math.sqrt(Math.max(0.0, 1.0 - c*c));

      for (var sign2 = 1; sign2 >= -1; sign2 -= 2) {
        var nx = vx * c - sign2 * h * vy;
        var ny = vy * c + sign2 * h * vx;
      
        res[i][0] = x1 + r1 * nx;
        res[i][1] = y1 + r1 * ny;
        res[i][2] = x2 + sign1 * r2 * nx;
        res[i][3] = y2 + sign1 * r2 * ny;
        i++;
      }
    }
    return res;
  }

  // Controls

  d3.selectAll('input[type="range"]').on("change", change);
  function change() {
    // console.log(this.name + ' = ' + this.value);
    eval(this.name + ' = ' + this.value); // DIRTY!
    // var transition = vis.transition().duration(250);
    // // var delay = function(d, i) { return i * 50; };
    // transition.selectAll(".one")
    //   // .delay(delay)
    //   .attr("transform", "translate(" + one.x + ',' + one.y + ")");
    draw();
  }
  // var inputs = document.querySelectorAll('input[type="range"]');
  // for (var i = 0; i < inputs.length; i++) {
  //   inputs[i].addEventListener('input', function(e) {
  //     eval(this.name + ' = ' + this.value); // DIRTY!
  //     draw();
  //   });
  // }
  // document.querySelector('input[type="checkbox"]').addEventListener('click', function(e) {
  //   outlines = this.checked;
  //   draw();
  // });

  function draw() {
    // Having troubling finding a nice data driven way to do this, since
    // each arc and line is kind of unique, so just remove all and redraw.
    vis.selectAll('*').remove();
    var stroke = 3;

    //   if (outlines) {
    //     ctx.lineWidth = 2;

    //     ctx.strokeStyle = "#ff0000";
    //     ctx.beginPath();
    //     ctx.arc(one.x,one.y,one.radius,0, 2*Math.PI);
    //     ctx.stroke();

    //     ctx.strokeStyle = "#00ff00";
    //     ctx.beginPath();
    //     ctx.arc(two.x,two.y,two.radius,0, 2*Math.PI);
    //     ctx.stroke();

    //     ctx.strokeStyle = "#0000ff";
    //     ctx.beginPath();
    //     ctx.arc(three.x,three.y,three.radius,0, 2*Math.PI);
    //     ctx.stroke();

    //     ctx.strokeStyle = "#ff00ff";
    //     ctx.beginPath();
    //     ctx.arc(four.x,four.y,four.radius,0, 2*Math.PI);
    //     ctx.stroke();
    //   }


    // Outside tangents

    // var angleOneTwo = Math.atan2(two.y - one.y, two.x - one.x);
    // var angleOneTwo = Math.PI/180*45;
    var angleOneTwo = Math.atan((two.y-one.y)/(two.x-one.x)) - Math.acos((two.radius-one.radius)/(Math.sqrt((two.x-one.x)^2 + (two.y - one.y)^2 )));
    // console.log(angleOneTwo)
    // var angleOneToTwoTangent = angleOneTwo + (Math.atan(-0.5) * Math.PI);
    var angleOneToTwoTangent = angleOneTwo;
    // console.log(angleOneToTwoTangent);

    // vis.append("line")
    //   .attr("x1", one.x + Math.cos(angleOneToTwoTangent)*one.radius)
    //   .attr("y1", one.y + Math.sin(angleOneToTwoTangent)*one.radius)
    //   .attr("x2", two.x + Math.cos(angleOneToTwoTangent)*two.radius)
    //   .attr("y2", two.y + Math.sin(angleOneToTwoTangent)*two.radius)
    //   .attr("stroke-width", stroke)
    //   .attr("stroke", "white");

  var somethingOne = circleTangents(one.x, one.y, one.radius, two.x, two.y, two.radius);

      vis.append("line")
      .attr("x1", somethingOne[1][0])
      .attr("y1", somethingOne[1][1])
      .attr("x2", somethingOne[1][2])
      .attr("y2", somethingOne[1][3])
      .attr("stroke-width", stroke)
      .attr("stroke", "white");



    var angleThreeFour = Math.atan2(four.y - three.y, four.x - three.x);
    var angleThreeToFourTangent = angleThreeFour + (Math.atan(-0.5) * Math.PI)

    // vis.append("line")
    //   .attr("x1", three.x + Math.cos(angleThreeToFourTangent)*three.radius)
    //   .attr("y1", three.y + Math.sin(angleThreeToFourTangent)*three.radius)
    //   .attr("x2", four.x + Math.cos(angleThreeToFourTangent)*four.radius)
    //   .attr("y2", four.y + Math.sin(angleThreeToFourTangent)*four.radius)
    //   .attr("stroke-width", stroke)
    //   .attr("stroke", "white");

    var somethingTwo = circleTangents(two.x, two.y, two.radius, four.x, four.y, four.radius);

      vis.append("line")
      .attr("x1", somethingTwo[3][0])
      .attr("y1", somethingTwo[3][1])
      .attr("x2", somethingTwo[3][2])
      .attr("y2", somethingTwo[3][3])
      .attr("stroke-width", stroke)
      .attr("stroke", "white");

    // Inside tangents

    var angleTwoFour = Math.atan2(four.y - two.y, four.x - two.x);
    var angleTwoToFourTangent = angleTwoFour + (Math.atan(-0.5) * Math.PI)
    var angleTwoToFourTangentReverse = angleTwoFour + (Math.tan(0.5) * Math.PI)

    // vis.append("line")
    //   .attr("x1", two.x + Math.cos(angleTwoToFourTangent)*two.radius)
    //   .attr("y1", two.y + Math.sin(angleTwoToFourTangent)*two.radius)
    //   .attr("x2", four.x + Math.cos(angleTwoToFourTangentReverse)*four.radius)
    //   .attr("y2", four.y + Math.sin(angleTwoToFourTangentReverse)*four.radius)
    //   .attr("stroke-width", stroke)
    //   .attr("stroke", "white");

var somethingThree = circleTangents(four.x, four.y, four.radius, three.x, three.y, three.radius);
     vis.append("line")
      .attr("x1", somethingThree[0][0])
      .attr("y1", somethingThree[0][1])
      .attr("x2", somethingThree[0][2])
      .attr("y2", somethingThree[0][3])
      .attr("stroke-width", stroke)
      .attr("stroke", "white");


    var angleThreeOne = Math.atan2(one.y - three.y, one.x - three.x);
    var angleThreeToOneTangent = angleThreeOne + (Math.tan(-0.5) * Math.PI)
    var angleThreeToOneTangentReverse = angleThreeOne + (Math.atan(0.5) * Math.PI)

    // vis.append("line")
    //   .attr("x1", three.x + Math.cos(angleThreeToOneTangentReverse)*three.radius)
    //   .attr("y1", three.y + Math.sin(angleThreeToOneTangentReverse)*three.radius)
    //   .attr("x2", one.x + Math.cos(angleThreeToOneTangent)*one.radius)
    //   .attr("y2", one.y + Math.sin(angleThreeToOneTangent)*one.radius)
    //   .attr("stroke-width", stroke)
    //   .attr("stroke", "white");

var somethingFour = circleTangents(three.x, three.y, three.radius, one.x, one.y, one.radius);
    
    vis.append("line")
      .attr("x1", somethingFour[2][0])
      .attr("y1", somethingFour[2][1])
      .attr("x2", somethingFour[2][2])
      .attr("y2", somethingFour[2][3])
      .attr("stroke-width", stroke)
      .attr("stroke", "white");



    // Arcs

    // One
    // var arc = d3.svg.arc()
    //   .innerRadius(one.radius - stroke/2)
    //   .outerRadius(one.radius - stroke/2 + stroke)
    //   .startAngle(angleThreeToOneTangent + 90 * (Math.PI/180))
    //   .endAngle(angleOneToTwoTangent + 0.5*Math.PI)
    var arc = d3.svg.arc()
      .innerRadius(one.radius - stroke/2)
      .outerRadius(one.radius - stroke/2 + stroke)
      .startAngle(Math.PI+Math.atan( (one.x-somethingFour[2][2])/(somethingFour[2][3]-one.y) ))
      .endAngle(2*Math.PI+Math.atan( (one.x-somethingOne[1][0])/(somethingOne[1][1]-one.y) ))

    vis.append("path")
      .attr("class", "one")
      .attr("d", arc)
      .style("fill", 'white')
      .attr("transform", "translate(" + one.x + ',' + one.y + ")")

    // Two
    var arc = d3.svg.arc()
      .innerRadius(two.radius - stroke/2)
      .outerRadius(two.radius - stroke/2 + stroke)
      .startAngle(Math.atan( (two.x-somethingOne[1][2])/(somethingOne[1][3]-two.y) ))
      .endAngle(Math.PI+Math.atan( (two.x-somethingTwo[3][0])/(somethingTwo[3][1]-two.y) ))

    vis.append("path")
      .attr("d", arc)
      .style("fill", 'white')
      .attr("transform", "translate(" + two.x + ',' + two.y + ")")

    // Three
     var arc = d3.svg.arc()
      .innerRadius(three.radius - stroke/2)
      .outerRadius(three.radius - stroke/2 + stroke)
      .startAngle(Math.atan( (three.x-somethingFour[2][0])/(somethingFour[2][1]-three.y) ))
      .endAngle(Math.PI+Math.atan( (three.x-somethingThree[0][2])/(somethingThree[0][3]-three.y) ))

    vis.append("path")
      .attr("d", arc)
      .style("fill", 'white')
      .attr("transform", "translate(" + three.x + ',' + three.y + ")")



    // Four
    var arc = d3.svg.arc()
      .innerRadius(four.radius - stroke/2)
      .outerRadius(four.radius - stroke/2 + stroke)
      .startAngle(Math.PI+Math.atan( (four.x-somethingThree[0][0])/(somethingThree[0][1]-four.y) ))
      .endAngle(2*Math.PI+Math.atan( (four.x-somethingTwo[3][2])/(somethingTwo[3][3]-four.y) ))

    vis.append("path")
      .attr("d", arc)
      .style("fill", 'white')
      .attr("transform", "translate(" + four.x + ',' + four.y + ")")
  }
  draw();
  </script>
</body>
</html>
